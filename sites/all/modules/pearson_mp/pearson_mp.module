<?php
define('PEARSON_ROLES', serialize(array('Pearson Student', 'Pearson Professor', 'Pearson TA')));
// TODO: make a more error-proof require later
require_once 'sites/all/libraries/CryptLib/bootstrap.php'; // for doing encryption

function pearson_mp_views_api(){
	return array('api' => 2);
}

function example_page() {
  $data = array(
    array('fruit' => 'apple', 'votes' => 16),
    array('fruit' => 'mango', 'votes' => 10),
    array('fruit' => 'banana', 'votes' => 34),
    array('fruit' => 'peach', 'votes' => 20),
    array('fruit' => 'orange', 'votes' => 15),
  );
 
  $options_pie = array(
    'title' => 'Favourite fruits',
    'fields' => array(
      'votes' => array(
        'label' => t('Votes'),
        'enabled' => TRUE,
      ),
    ),
    'xAxis' => array(
      'labelField' => 'fruit',
    ),
    'data' => $data,
    'type' => 'pie',
  );
 
  $options_column = array(
    'title' => 'Favourite fruits',
    'fields' => array(
      'votes' => array(
        'label' => t('Votes'),
        'enabled' => TRUE,
      ),
    ),
    'xAxis' => array(
      'labelField' => 'fruit',
    ),
    'data' => $data,
    'type' => 'column',
  );
 
  $build['pie'] =  array(
    '#theme' => 'visualization',
    '#options' => $options_pie,
  );
 
  $build['column'] =  array(
    '#theme' => 'visualization',
    '#options' => $options_column,
  );
 
  return $build;
}
/*
 * Hook theme, used for the Ajax modal
 * ctools_ajax_sample_container --> pearson_goal_container
 */  
function pearson_mp_theme() {
  return array(
    // Sample theme functions.
    'pearson_goal_container' => array(
      'arguments' => array('content' => NULL, 'nid' => NULL),
    ),
  );
}

/**
 * Theme function for main rendered output.
 */
function theme_pearson_goal_container($vars) {
  // TODO: need to add a unique number to the end of it, so two classes don't get updated simultaneously
  $output = '<div id="pearson-goal-num' . $vars['nid'] . '"><span class="pearsonBig">';
  $output .= $vars['content'];
  $output .= '</span></div>';

  return $output;
}

function _syllabus_page(){
	$form = array();
	// dsm($_GET, 'get');
	$cid = isset($_GET['CourseID']) ? $_GET['CourseID'] : ''; 
	$syllabusHTML = remoteOAuth1('/courses/' . $cid . '/syllabus', FALSE, FALSE);
	$firstFive = substr($syllabusHTML, 0, 5);
	
	if ($firstFive == 'error'){
		// this means there was an error getting it, which happens when there isn't a syllabus provided
		$syllabusHTML = 'There was no syllabus found for this course. (You may want to try the two courses that were assigned to me.)';
	}
	
	$form['ht'] = array(
	 '#type' => 'markup',
	 '#markup' => $syllabusHTML,
	);	
	
	return $form;
}

function pearson_mp_animal($js = NULL, $step = NULL) {
  if ($js) {
    ctools_include('modal');
    ctools_include('ajax');
  }

  $form_info = array(
    'id' => 'animals',
    'path' => "pearson_mp/" . ($js ? 'ajax' : 'nojs') . "/animal/" . arg(3) . '/' . arg(4),
    // 'path' => "pearson_mp/" . ($js ? 'ajax' : 'nojs') . "/animal/%step",
    'show trail' => FALSE,
    'show back' => FALSE,
    'show cancel' => TRUE,
    'show return' => FALSE,
    'finish callback' => 'pearson_mp_wizard_finish',
    'cancel callback' => 'pearson_mp_wizard_cancel',
   // this controls order, as well as form labels
    'order' => array(
      'start' => t('Pick goal (percentage)'),
    ),
   // here we map a step to a form id.
    'forms' => array(
      // e.g. this for the step at wombat/create
      'start' => array(
        'form id' => 'pearson_mp_start'
      ),
    ),
  );  

  $form_state = array(
    'ajax' => $js,
    // Put our object and ID into the form state cache so we can easily find
    // it.
    'object_id' => $object_id,
    'object' => &$object,
  );

	// mike: here we add the course and user info
  $args = arg();
  // dsm($args, 'args');
  if (count($args) == 5){
  	// we want there to be the uid and nid passed in
  	$form_state['uid'] = arg(3); 
  	$form_state['nid'] = arg(4); 
  }
  $uid = $form_state['uid'];
  $nid = $form_state['nid'];

  // dsm($form_state, 'fs');
  
  // see if there is an existing goal node for this user and course
  
  $query = db_select('field_data_field_pearson_goal_course', 'c');
  $query->join('field_data_field_pearson_goal_user', 'u', 'c.entity_id = u.entity_id');
  $query->join('field_data_field_pearson_goal_percent', 'p', 'u.entity_id = p.entity_id');
  $query->fields('p', array('field_pearson_goal_percent_value'))
    ->fields('c', array('entity_id'))
  	->condition('u.field_pearson_goal_user_target_id', $uid)
	->condition('c.field_pearson_goal_course_target_id', $nid);
  $results = $query->execute()->fetch();
  
  // dsm($results);  
  
  if (empty($results)){
  	// NO GOAL for this person and course
  	$form_state['hasGoal'] = FALSE;
	$form_state['goalValue'] = '';
	$form_state['goalID'] = '';
  } else {
  	// GOAL EXISTS for this person and course
  	$form_state['hasGoal'] = TRUE;
  	$form_state['goalValue'] = $results->field_pearson_goal_percent_value;
	$form_state['goalID'] = $results->entity_id;
  }
  

  
  // Send this all off to our form. This is like drupal_get_form only wizardy.
  ctools_include('wizard');
  $form = ctools_wizard_multistep_form($form_info, $step, $form_state);
  // $form['goal']['#default_value'] = 'test';
  $form['goal']['#value'] = $form_state['goalValue'];
  // dsm($form, 'form');
  $output = drupal_render($form);  

  // If $output is FALSE, there was no actual form.
  
  if ($js) {
  	// dsm($js. 'js');
    // If javascript is active, we have to use a render array.
    $commands = array();
    if ($output === FALSE || !empty($form_state['complete'])) {
    	// dsm('first');
      // Dismiss the modal.
      // TODO: Validation
      
      _save_goal($form_state['hasGoal'], $form_state['goalValue'], $form_state['values']['goal'], $form_state['goalID'], $uid, $nid);
      
	  
	  $goalLink = ctools_modal_text_button(t('Change goal'), "pearson_mp/nojs/animal/$uid/$nid", t('Set goal'),  'ctools-modal-ctools-sample-style');
      $container = theme('pearson_goal_container', array('content' => "$goalLink <span class=\"pearsonBig\">{$form_state['values']['goal']}%</span>", 'nid' => $nid));
    
      $commands[] = ajax_command_html('#pearson-goal-num' . $nid, $container);
      $commands[] = ctools_modal_command_dismiss();
    }
    else if (!empty($form_state['cancel'])) {
    	// dsm('second');
      // If cancelling, return to the activity.
      $commands[] = ctools_modal_command_dismiss();
    }
    else {
    	// dsm('third');
      $commands = ctools_modal_form_render($form_state, $output);
    }
    print ajax_render($commands);
    exit;
  }
  else {
    if ($output === FALSE || !empty($form_state['complete'])) {
      return $animal;
    }
    else if (!empty($form_state['cancel'])) {
      drupal_goto('');
    }
    else {
      return $output;
    }
  }
}

function pearson_mp_wizard_finish(&$form_state) {
  $form_state['complete'] = TRUE;
}

function pearson_mp_wizard_cancel(&$form_state) {
  $form_state['cancel'] = TRUE;
}

/**
 * Wizard start form. Choose an animal.
 */
function pearson_mp_start($form, &$form_state) {
  $form_state['title'] = t('Set goal');

	$form['goal'] = array(
	  '#type' => 'textfield',
	  '#title' => t('Goal'),
	  '#size' => 10,
	  '#maxlength' => 4,
	  '#required' => TRUE,
	);  

  return $form;
}

function _save_goal($hasGoal, $goalValue, $newValue, $goalID, $uid, $nid){
	// dsm($hasGoal, 'hasGoal');
	// dsm($goalValue, 'goalValue');
	// dsm($newValue, 'newValue');
	// dsm($goalID, 'goalID');
	// dsm($uid, 'uid in save goal');
	// dsm($nid, 'nid in save goal');
	
	$newNode = (object) NULL;
	$newNode->type = 'pearson_goal';
	$newNode->uid = 1;
	$newNode->changed = strtotime("now");
	$newNode->status = 1;
	$newNode->comment = 0;
	$newNode->promote = 0;
	$newNode->moderate = 0;
	$newNode->sticky = 0;
	$newNode->language = 'und';
	$newNode->title = "Goal: User $uid for Course $nid";
				
	$newNode->field_pearson_goal_course[LANGUAGE_NONE][0]['target_id'] = $nid; // add this to the entity reference for course
	$newNode->field_pearson_goal_course[LANGUAGE_NONE][0]['target_type'] = 'node'; // required	
	$newNode->field_pearson_goal_user[LANGUAGE_NONE][0]['target_id'] = $uid; // add this to the entity reference for course
	$newNode->field_pearson_goal_user[LANGUAGE_NONE][0]['target_type'] = 'user'; // required			
	$newNode->field_pearson_goal_percent[LANGUAGE_NONE][0]['value'] = $newValue; 	
	
	if ($hasGoal){
		// Goal node exists
		// if they're the same value, return
		if ($goalValue == $newValue) return;
		//updating node
		$newNode->nid = $goalID;
		$newNode->vid = $goalID; // will throw notice without this line						
	} else {
		// create new Goal node
		$newNode->created = strtotime("now");	
		$newNode->is_new = TRUE;				
	}
	
	node_save($newNode);	
	watchdog('pearson_mp', 'Created/updated goal for User ' . $uid . ' with Course ' . $nid);
	 
}

// hook_menu
function pearson_mp_menu(){
	$items = array();
  $items['pearson_mp/%ctools_js/animal/%/%'] = array(
      'title' => 'Goal',
      'page callback' => 'pearson_mp_animal',
      'page arguments' => array(1),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
  );	  
  
  $items['pearson_mp/%ctools_js/animal'] = array(
      'title' => 'Goal',
      'page callback' => 'pearson_mp_animal',
      'page arguments' => array(1),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
  );	
	
  $items['example-charts'] = array(
    'title' => 'Example',
    'page callback' => 'example_page',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );	
  $items['syllabus'] = array(
    'title' => 'Course Information',
    'page callback' => '_syllabus_page',
    'access arguments' => array('access content'),
    'type' => MENU_CALLBACK,
  );	
	$items['mp/test'] = array(
		'type' => MENU_NORMAL_ITEM,		
		'title' => 'mp test',		
		'description' => 'test for ReST',		
		'page callback' => '_debug_mp',
		'page arguments' => array('hardcoded'),
		'access callback' => TRUE,
		'expanded' => TRUE,
  );
  $items['pearson-mp/ajaxgrade/%'] = array(
      'title' => 'Made for a button',
      'page callback' => '_ajax_grade',
      'page arguments' => array(2),
      'access callback' => TRUE,
      'type' => MENU_CALLBACK,
  );  
  
  $items['mp/test/prof'] = array(
    'title' => 'Prof form',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('_mpProf'),
    'access callback' => TRUE,
    'description' => 'we want to find details about this professor',
    'type' => MENU_NORMAL_ITEM,
  );
  
  $items['admin/settings/pearson_mp'] = array(
    'title' => 'Pearson Settings',
    'description' => 'Change/view Application ID, Client String, etc.',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('_pearson_settings'),
    'access arguments' => array('administer pearson settings'),
    'type' => MENU_NORMAL_ITEM,
   );    
   
  $items['course-entry'] = array(
    'title' => 'Course Entry',
    'description' => 'Enter course',
    'page callback' => '_pearson_course_entry',
    'access arguments' => array('access content')
   );    
    
  return $items;
}

function _pearson_settings($form, &$form_state) {
  $form = array();

  $form['pearson_app_id'] = array(
    '#type' => 'textfield',
    '#title' => t('Pearson Application ID'),
    '#default_value' => variable_get('pearson_app_id'),
    '#description' => t("Used for all clients."),
    '#required' => TRUE,
  );
  $form['pearson_client_string'] = array(
    '#type' => 'textfield',
    '#title' => t('Pearson Client String'),
    '#default_value' => variable_get('pearson_client_string'),
    '#description' => t("Unique for Integration Campus."),
    '#required' => TRUE,
  );
  $form['pearson_term_id'] = array(
    '#type' => 'textfield',
    '#title' => t('Enter current Term ID'),
    '#default_value' => variable_get('pearson_term_id'),
    '#required' => TRUE,
  );
  $form['pearson_consumer_key'] = array(
    '#type' => 'textfield',
    '#title' => t('Enter Consumer Key (AKA: Token Key Moniker)'),
    '#default_value' => variable_get('pearson_consumer_key'),
    '#required' => TRUE,
  );
  $form['pearson_consumer_secret'] = array(
    '#type' => 'textfield',
    '#title' => t('Enter Consumer Secret (AKA: Shared Secret)'),
    '#default_value' => variable_get('pearson_consumer_secret'),
    '#required' => TRUE,
  );
  $form['pearson_principal'] = array(
    '#type' => 'textfield',
    '#title' => t('Principal'),
    '#default_value' => variable_get('pearson_principal'),
    '#required' => TRUE,
  );
  $form['pearson_principal_shared'] = array(
    '#type' => 'textfield',
    '#title' => t('Principal Shared Secret'),
    '#default_value' => variable_get('pearson_principal_shared'),
    '#required' => TRUE,
  );
  
  // begin adding links
  $defaultsLinks = variable_get('names_fieldset');
  $valsSet = FALSE;
  if (!empty($defaultsLinks)) $valsSet = TRUE;
  // dsm($defaultsLinks, 'default links');
  
  $form['#tree'] = TRUE;
  $form['names_fieldset'] = array(
    '#type' => 'fieldset',
    '#title' => t('Common links to access'),
    // Set up the wrapper so that AJAX will be able to replace the fieldset.
    '#prefix' => '<div id="names-fieldset-wrapper">',
    '#suffix' => '</div>',
  );

  // Build the fieldset with the proper number of names. We'll use
  // $form_state['num_names'] to determine the number of textfields to build.
  if (empty($form_state['num_names'])) {
    $form_state['num_names'] = 1;
	if ($valsSet) $form_state['num_names'] = count($defaultsLinks['pearson_link']);	  	
  }
  
	  
  for ($i = 0; $i < $form_state['num_names']; $i++) {
    $form['names_fieldset']['pearson_linkdesc'][$i] = array(
      '#type' => 'textfield',
      '#title' => t($i+1 . '. Description'),
      '#default_value' => ($valsSet) ? $defaultsLinks['pearson_linkdesc'][$i] : '',
    );
    $form['names_fieldset']['pearson_link'][$i] = array(
      '#type' => 'textfield',
      '#title' => t($i+1 . '. Link'),
	  '#default_value' => ($valsSet) ? $defaultsLinks['pearson_link'][$i] : '',      
    );
  }
  $form['names_fieldset']['add_name'] = array(
    '#type' => 'submit',
    '#value' => t('Add'),
    '#submit' => array('pearson_mp_add_more_add_one'),
    // See the examples in ajax_example.module for more details on the
    // properties of #ajax.
    '#ajax' => array(
      'callback' => 'pearson_mp_add_more_callback',
      'wrapper' => 'names-fieldset-wrapper',
    ),
  );
  if ($form_state['num_names'] > 1) {
    $form['names_fieldset']['remove_name'] = array(
      '#type' => 'submit',
      '#value' => t('Remove'),
      '#submit' => array('pearson_mp_add_more_remove_one'),
      '#ajax' => array(
        'callback' => 'pearson_mp_add_more_callback',
        'wrapper' => 'names-fieldset-wrapper',
      ),
    );
  } 
  
  // TODO: add submit button to reset all bundles

  return system_settings_form($form);
}

function pearson_mp_add_more_callback($form, $form_state) {
  return $form['names_fieldset'];
}

function pearson_mp_add_more_add_one($form, &$form_state) {
  $form_state['num_names']++;
  $form_state['rebuild'] = TRUE;
}

function pearson_mp_add_more_remove_one($form, &$form_state) {
  if ($form_state['num_names'] > 1) {
    $form_state['num_names']--;
  }
  $form_state['rebuild'] = TRUE;
}

function _pearson_course_entry() {
	// get the UserID, CourseID
	$userID = $_GET['UserID'];
	$userName = $_GET['UserName'];
	$courseID = $_GET['CourseID'];
	
	// $body = '{"webEntry":{"userId":' . $userID . ',"courseId":' . $courseID . ',"exitUrl":"http:\/\/www.ecollege.com","logoutUrl":"http:\/\/code.educationalpartner.com","courseReturnUrl":"http:\/\/www.mikedotexe.com"}}';
	
	$body = array();
	$body['webEntry'] = array('userId' => (int) $userID, 'courseId' => (int) $courseID, 'exitUrl' => 'http://www.ecollege.com', 'logoutUrl' => 'http://code.educationalpartner.com', "courseReturnUrl" => "http://www.mikedotexe.com");
	$body = json_encode($body);	
	
	// dsm($body, 'body');
	
	$access = remoteOAuth2GETAssertion($userName);
	// dsm($access, 'access');
	$ceObj = remoteOAuth2POST($access->access_token, '/lsEntry/course', $body);
	// dsm($ceObj, 'course entry object');
	$url = $ceObj->lsEntry->entryUrl;
	
	drupal_goto($url);
	// return '<div>' . 'mike' . '</div><br /><div>' . 'here' . '</div>';
}

function pearson_mp_permission() {
  return array(
    'administer pearson settings' => array(
      'title' => t('Access and change Pearson settings'),
      'description' => t('Allow users to access the settings page, change Application ID, etc...'),
    ),
	'pearson see all students' => array(
	  'title' => t('Allowed to see other students in the system, basic information like email and classes'),
	  'description' => t('On by default')
    ),
	'pearson see all grades' => array(
	  'title' => t('Allowed to see other students\' grades'),
	  'description' => t('Perhaps for teachers and teaching assistants')
    )
	);
}
// hook cron
function pearson_mp_cron(){
	watchdog('pearson_mp', 'running cron');
    $queueCoursesFromTerm = DrupalQueue::get("pearsonCourseFromTerm");
    // $queueUsersInCourses = DrupalQueue::get("pearsonUserFromCourse");
	
	// get list of courses from the term_id
	$term = variable_get('pearson_term_id');
	if (empty($term)){
		drupal_set_message('Pearson settings must be entered here: ' . l('Visit Pearson Settings (required)', 'admin/settings/pearson_mp'));
		return;
	}	
	
	$remoteAll = remoteOAuth1('/terms/' . $term . '/courses');
	// check to see if the hash is the same, function returns TRUE if there is new stuff
	$remoteAllSer = serialize($remoteAll);
	$newCoursesInfo = newHashedInfo('coursesFromTerm', $term, $remoteAllSer);
	if ($newCoursesInfo) variable_set('pearson updateCourseInfo', TRUE); // if there's new stuff to add from courses. need to know final ID too, see below
	$finalCourseID = '';
	if (is_array($remoteAll->courses)){ // this helps block warnings
		foreach ($remoteAll->courses as $k => $v){
		  // dsm($k, 'k'); // $k->id, ->displayCourseCode, ... title, callNumbers (array), links (array of Objects->href, ->rel)
		  
		  // now that we know who to attach to a course, create/update course nodes
		  $queueCoursesFromTerm->createItem($v);
		  $finalCourseID = $v->id;
		}
		// set variable so we know when the last one is processed later, and can turn 'pearson updateCourseInfo' to FALSE
		variable_set('pearson updateCourseInfo FinalID', $finalCourseID);		
	}
	// watchdog('pearson_mp_debug', 'Calling checkC');
	checkAnnouncements();
	// checkIQT();
}

/*
 * Check for announcements
 * @$IDarray is an array of Pearson Course ID's to check
 */
function checkAnnouncements($IDarray = array()){
	$queueAnnFromCourse = DrupalQueue::get("pearsonAnnouncementFromCourse");
	if (empty($IDarray)){
		// want to check all announcements from all courses
		// TODO: not sure if we need to get hash information below
		$query = db_select('node', 'n');
		$query->join('field_data_field_pearson_course_number', 'c', 'n.nid = c.entity_id');
		$query->leftjoin('pearson_mp_hashes', 'h', 'c.field_pearson_course_number_value = h.description');
		// $query->fields('c', array('field_pearson_course_number_value'))->fields('h', array('hash'))->condition('n.type', 'pearson_course')->condition('h.type', 'ann');
		$query->fields('c', array('field_pearson_course_number_value'))->fields('h', array('hash'))->condition('n.type', 'pearson_course');
		$result = $query->execute()->fetchAll();
		
		// $debug1 = serialize($result);
		// watchdog('pearson_mp_debug', 'serialized result in checkAnnoucnements ' . $debug1);
		// dsm($result, 'result');\		
		foreach ($result as $k => $v) {			
			$queueAnnFromCourse->createItem($v);
		}
	} else {
		// only check for announcements from a particular course
		watchdog('pearson_mp_debug', 'should not be here');
		foreach ($IDarray as $cid){
			$query = db_select('pearson_mp_hashes', 'h');
			$query->fields('h', array('hash'))->condition('h.description', $cid)->condition('h.type', 'ann');
			$result = $query->execute()->fetchAll();
			if (empty($result)){
				$result[0] = new stdClass();
				$result[0]->hash = NULL;
			} 
			$result[0]->field_pearson_course_number_value = $cid;
			// dsm($result[0], 'result');
			
			// add to queue			
			$queueAnnFromCourse->createItem($result[0]);
		}
	}
} 

function checkIQT($uidForce = FALSE){
	if ($uidForce){
		// we want to remove existing IQT hashes in the database involving IQTs attached to this user
		// see if there are any hashes
		// dsm($uidForce, 'uidforce');
		
		$q0 = db_select('field_data_field_pearson_course_users', 'u');
		$q0->join('field_data_field_pearson_iqt_course', 'c', 'u.entity_id = c.field_pearson_iqt_course_target_id'); // joined on uid
		$q0->join('field_data_field_pearson_iqt_guid', 'g', 'c.entity_id = g.entity_id'); // joined on uid
		$q0->fields('g', array('field_pearson_iqt_guid_value'))
			->condition('u.field_pearson_course_users_target_id', $uidForce);
		$r0 = $q0->execute()->fetchAll();		
		// now we have th GUIDs we want to remove fromt he hash table, so do it
		foreach ($r0 as $guidInside) {
			// dsm($guidInside, 'guidInside');
			$fakeNode = (object) NULL;
			$fakeNode->field_pearson_iqt_guid[LANGUAGE_NONE][0]['value'] = $guidInside->field_pearson_iqt_guid_value;
			// dsm($fakeNode, 'fn');
			_remove_hash('iqt', $fakeNode);	
		}
		 
		// dsm($r0, 'r0');
	}		
	
	// $queueIQT = DrupalQueue::get("pearsonIQT");
	// find all the people who have entered phone numbers into their account	
	// find all the courses they're enrolled in
	$q = db_select('field_data_field_pearson_user_phone', 'p');
	$q->join('field_data_field_pearson_course_users', 'c', 'p.entity_id = c.field_pearson_course_users_target_id'); // joined on uid
	$q->join('field_data_field_pearson_user_id', 'u', 'p.entity_id = u.entity_id'); // joined on uid
	$q->join('field_data_field_pearson_course_number', 'n', 'c.entity_id = n.entity_id'); // joined on course id
	$q->fields('n', array('field_pearson_course_number_value'))
		->fields('u', array('field_pearson_user_id_value'))
		->fields('c', array('entity_id'))
		->condition('p.field_pearson_user_phone_value', '', '!=');
	$r = $q->execute()->fetchAll();
	// dsm($r, 'results');
	
	$IQTs = array(); // this will be filled with objects that will be turend into nodes
	
	// now we have the Pearson UserID and Pearson CourseID, which is needed for the full IQT object
	foreach ($r as $k => $v){ // looping through courses
		// look for all upcoming items for this courses
		$uid = $v->field_pearson_user_id_value;
		$cid = $v->field_pearson_course_number_value;
		$nid = $v->entity_id;
		$upcoming = remoteOAuth1("/users/$uid/courses/$cid/upcomingevents");
		// dsm($upcoming, 'upcoming');
		
		foreach ($upcoming->upcomingEvents as $key => $value) {
			// dsm($value, 'value');
			if ($value->type != 'IQT' || $value->category != 'start') continue; // we only care about Quizzes (IQT), and we only want when it starts (not ends)
			
			// look for all IQT's and build array of objects
			$time = $value->when->time;
			// dsm($time, '$time');
			// dsm($upcoming, '$upcoming');
			$itemID = $value->id;
			$titleHeading = $value->titleHeading;
			$title = $value->title;
			
			$gradebookItem = remoteOAuth1("/courses/$cid/items/$itemID/gradebookItem");
			// dsm($gradebookItem, '$gradebookItem');
			$href = $gradebookItem->gradebookItem->links[0]->href;
			$pos = strrpos($href, '/');
			$guid = substr($href, $pos + 1);
			
			// dsm($guid, '$guid');
			$gradeDetailsItem = remoteOAuth1("/courses/$cid/gradebookItems/$guid");
			// dsm($gradeDetailsItem, '$gradeDetailsItem');
			$points = $gradeDetailsItem->gradebookItems[0]->pointsPossible;
			// dsm($points, '$points');		
			
			// make the object and add to array
			$newNode = (object) NULL;
			$newNode->title = $title;
			$newNode->type = 'pearson_iqt';
			$newNode->uid = 1;			
			$newNode->status = 1;
			$newNode->comment = 0;
			$newNode->promote = 0;
			$newNode->moderate = 0;
			$newNode->sticky = 0;
			$newNode->language = 'und';
		
			$newNode->field_pearson_iqt_titleheading[LANGUAGE_NONE][0]['value'] = $titleHeading;
			$newNode->field_pearson_iqt_time[LANGUAGE_NONE][0]['value'] = $time;
			$newNode->field_pearson_iqt_guid[LANGUAGE_NONE][0]['value'] = $guid;
			$newNode->field_pearson_iqt_pointspossible[LANGUAGE_NONE][0]['value'] = $points;			
									
			$newNode->field_pearson_iqt_course[LANGUAGE_NONE][0]['target_id'] = $nid; // add this to the entity reference for course
			$newNode->field_pearson_iqt_course[LANGUAGE_NONE][0]['target_type'] = 'node'; // required				
			$IQTs[] = $newNode;
		}
	}	
	// dsm($IQTs, 'Array of new node objects to create');		
	// loop through and create nodes
	
	foreach ($IQTs as $newNode) {
		// TODO: check to see if it exists, whether to update or create new
		// let's get the entity_id (node id) of the IQT if it exists
		$guid = $newNode->field_pearson_iqt_guid[LANGUAGE_NONE][0]['value'];
		$q = db_select('field_data_field_pearson_iqt_guid', 'g');
		$q->fields('g', array('entity_id'))->condition('g.field_pearson_iqt_guid_value', $guid);
		$r = $q->execute()->fetch();
		// dsm($r, 'r');
		// go ahead and compute the hash right now so we can use it in if blocks below
				
		// dsm($newNode, 'newnode');
		
		$serObj = serialize($newNode);
		$computedHash = hash("crc32b", $serObj);
		// dsm($computedHash, 'computedhash');
		// this has to be added in after the hash is computed or else it will always change the hash		
		$newNode->changed = strtotime("now");		
		
		if (empty($r)){
			// dsm('one');
			// we are creating a new IQT node
			$newNode->created = strtotime("now");	
			$newNode->is_new = TRUE;
			// dsm($newNode, 'newnode BEFORE');
			$brandNewNode = node_save($newNode);
			// dsm($newNode, 'newnode AFTER');
			// dsm($brandNewNode, 'brandnewnode');
			_add_hash('iqt', $guid, $computedHash, $newNode);	
		} else {
			// lets see if there is a hashed value
			// dsm($guid, 'guid value');
			$q2 = db_select('pearson_mp_hashes', 'p');
			$q2->fields('p', array('hash'))->condition('p.type', 'iqt')->condition('p.description', $guid);
			$r2 = $q2->execute()->fetch();
			// dsm($r2, 'r2');
			if (empty($r2)){
				// dsm('two');
				// no hash stored in the database
				$newNode->nid = $r->entity_id;
				$newNode->vid = $r->entity_id; // will throw notice without this line					
				node_save($newNode);
				_add_hash('iqt', $guid, $computedHash, $newNode);				
			} else {
				// there is a hash, compare it with the current object we're about to save
				$storedHash = $r2->hash;
				if ($computedHash != $storedHash){ // hashes differ
					// dsm('three');
					// we are updating this IQT node
					$newNode->nid = $r->entity_id;
					$newNode->vid = $r->entity_id; // will throw notice without this line					
					node_save($newNode);
					_add_hash('iqt', $guid, $computedHash, $newNode);
				}				
			}
		}
		
	}	
}

/*
 * This handles the queue that looks to update/add announcements
 */

function PearsonAnnouncements($item){
	// watchdog('pearson_mp_debug', 'Entering PearsonAnnouncements');
	$cid = $item->field_pearson_course_number_value;
	if (empty($cid)) return;	
	
	// $annData = remoteOAuth1("/courses/$cid/announcements")
	
	// get professor's username
	$query = db_select('field_data_field_pearson_course_number', 'c');
	$query->join('field_data_field_pearson_course_users', 'u', 'c.entity_id = u.entity_id');
	$query->join('users', 'd', 'u.field_pearson_course_users_target_id = d.uid');
	$query->join('users_roles', 'ur', 'd.uid = ur.uid');
	$query->join('role', 'r', 'ur.rid = r.rid');
	$query->join('field_data_field_pearson_username', 'n', 'd.uid = n.entity_id');
	$query->fields('n', array('field_pearson_username_value'))->condition('r.name', 'Pearson Professor')->condition('c.field_pearson_course_number_value', $cid);
	$res = $query->execute()->fetchAll();
	
	if (empty($res)){
		watchdog('pearson_mp', '[PearsonAnnouncements] Could not find username for teacher in course ' . $cid, NULL, WATCHDOG_CRITICAL);
		// watchdog('pearson_mp_debug', '[PearsonAnnouncements] Could not find username for teacher in course ' . $cid, NULL, WATCHDOG_CRITICAL);
		return;
	}
	
	$uname = $res[0]->field_pearson_username_value;
	
	// now that we have the professor's username, we can use OAuth2 assertion to get  
	$accessInfo = remoteOAuth2GETAssertion($uname);
	$accessToken = $accessInfo->access_token;
	
	// get announcements for course
	$announcements = remoteOAuth2GET($accessToken, '/courses/' . $cid . '/announcements');
	// watchdog('pearson_mp', 'Announcements for Course ' . $cid . ' (' . count($announcements->announcements) . ' total)');
	foreach ($announcements->announcements as $ann){
		updateOrAddAnnouncement($ann, $cid);
	}
	
}

function updateOrAddAnnouncement($item, $cid){
	// watchdog('pearson_mp_debug', 'Entering updateOrAddAnnouncement');
	// see if we have a node with that Pearson ID (not Drupal nid, or Node ID)
	// if so, return the nid, if not, return blank
	$findAnnID = $item->id;
	$query = db_select('node', 'n');
	$query->join('field_data_field_pearson_ann_id', 'b', 'n.nid = b.entity_id');
	$query
	  ->fields('n', array('nid', 'vid'))
	  ->condition('n.type', 'pearson_announcement')
	  ->condition('b.field_pearson_ann_id_value', $findAnnID);
	$result = $query->execute()->fetchAll();
	
	// see what the hash is, if there's already that announcement
	// TODO: see if we can use the newHashedInfo() return values instead of what's done here
	$query2 = db_select('pearson_mp_hashes', 'h');
	$query2->fields('h', array('hash'))->condition('h.type', 'ann')->condition('h.description', $item->id);
	$hashRes = $query2->execute()->fetchAll();
	$storedHash = $hashRes[0]->hash;
	
	// compare to computed hash
	$serialItem = serialize($item);
	$computedHash = hash("crc32b", $serialItem);
	
	// if they're the same, bail
	if ($computedHash == $storedHash){
		// same, no need to compute anymore
		watchdog('pearson_mp', 'Announcement hash the same for Announcement ID ' . $findAnnID);
		return;		
	}	
	  		  			
	$newNode = (object) NULL;
	$newNode->type = 'pearson_announcement';
	$newNode->uid = 1;
	$newNode->changed = strtotime("now");
	$newNode->status = 1;
	$newNode->comment = 0;
	$newNode->promote = 0;
	$newNode->moderate = 0;
	$newNode->sticky = 0;
	$newNode->language = 'und';

	$newNode->field_pearson_ann_id[LANGUAGE_NONE][0]['value'] = $findAnnID;
	$newNode->field_pearson_ann_subject[LANGUAGE_NONE][0]['value'] = $item->subject;
	$newNode->field_pearson_ann_text[LANGUAGE_NONE][0]['value'] = $item->text;
	$newNode->field_pearson_ann_submitter[LANGUAGE_NONE][0]['value'] = $item->submitter;
	$newNode->field_pearson_ann_startdisplayda[LANGUAGE_NONE][0]['value'] = $item->startDisplayDate;
	$newNode->field_pearson_ann_enddisplaydate[LANGUAGE_NONE][0]['value'] = $item->endDisplayDate;
	$newNode->title = $item->subject; // TODO: somewhat redundant
		
	// if we are updating this node
	if (!empty($result)){
		// we're updating this node
		//dsm('not empty');
		$newNode->nid = $result[0]->nid;
		$newNode->vid = $result[0]->vid; // will throw notice without this line
		// $newNode->is_new = FALSE;
	} else {
		// we're creating this node
		$newNode->created = strtotime("now");	
		$newNode->is_new = TRUE;	
	}
	
	// get the Drupal nid of the course it needs to point to, be a child of
	$query = db_select('field_data_field_pearson_course_number', 'p');
	$query->join('node', 'n', 'n.nid = p.entity_id');
	$query->fields('n', array('nid'))->condition('p.field_pearson_course_number_value', $cid);
	$result = $query->execute()->fetchAll();
	$nid = $result[0]->nid;	
	
	$newNode->field_pearson_ann_course[LANGUAGE_NONE][0]['target_id'] = $nid; // add this to the entity reference for course
	$newNode->field_pearson_ann_course[LANGUAGE_NONE][0]['target_type'] = 'node'; // required	
	
	node_save($newNode);	
	
	// add hash
	_add_hash('ann', $findAnnID, $computedHash, $item);
}
  
/*
*	Add hash to custom table we set up in hook_schema in pearson_mp.install
 *  $type might be coursesFromTerm
 * 	$description is now being typically used as the unique drupal ID
 */
function newHashedInfo($type, $description, &$item){
	$serialItem = serialize($item);
	// $hash = hash("crc32b", $item);
	$hash = hash("crc32b", $serialItem);
	// check to see if hash is the same as that in the database
	$query = db_select('pearson_mp_hashes', 'p');
	$query->fields('p', array('hash'))->condition('p.description', $description)->condition('p.type', $type);
	$result = $query->execute()->fetch();
	// TODO: this logic could probably be reduced to if(empty($result) || $result->hash != $hash), but keep it for easy debugging
	if (empty($result)){
		// never added to db before, add it
		_add_hash($type, $description, $hash, $item);
		return TRUE;
	} else {
		// found a previous entry in db
		// see if hashes are the same
		if ($result->hash == $hash){
			// everything is the same as the last time we checked
			// watchdog('pearson_mp', 'Nothing has been updated for hash ' . $type . ' ' . $description);
			return FALSE;
		} else {
			// it's different, go ahead and update stuff
			// update the hash in the database, and tell calling function that there's new stuff (TRUE)
			watchdog('pearson_mp', 'Adding hash for ' . $type . ' ' . $description);
			_add_hash($type, $description, $hash, $item);
			return TRUE;
		}
	}
}
 
function _add_hash($type, $description, $hash, &$item){
	// TODO: make sure this key is supposed to be at description
	db_merge('pearson_mp_hashes')
	  ->key(array('description' => $description))
	  ->fields(array(
	  	  'type' => $type,
	      'hash' => $hash,
	      'fulldata' => serialize($item),
	  ))
	  ->execute();	
}

// tell drupal we have a queue to work on during cron
function pearson_mp_cron_queue_info() {
  $ret = array();
  $ret['pearsonCourseFromTerm'] = array(
    'worker callback' => 'PearsonUpdateOrAdd', //function to call for each item
    'time' => 600, //seconds to spend working on the queue
  );
  $ret['pearsonAnnouncementFromCourse'] = array(
    'worker callback' => 'PearsonAnnouncements', //function to call for each item
    'time' => 600, //seconds to spend working on the queue
  );
  // $ret['pearsonUserFromCourse'] = array(
    // 'worker callback' => 'PearsonUpdateOrAddUser', //function to call for each item
    // 'time' => 600, //seconds to spend working on the queue
  // );
  return $ret;
}

function remoteOAuth1($route, $ct_urlenc = FALSE, $jsonEncode = TRUE){
	// Set up the variables necessary to make the Request 
	$method          = 'GET'; 
	$application_id  = variable_get('pearson_app_id');  //Your Application's ID/Key. Use for all campuses.
	$consumer_key    = variable_get('pearson_consumer_key');    //Campus-specific 
	$consumer_secret = variable_get('pearson_consumer_secret'); //Campus-specific  
	$nonce           = md5(microtime());   //Random & unique for every call
	$api_route       = $route;            //The API call you're requesting
	$post_body       = '{requestBody}';    //POST or PUT body
	$request_url     = 'https://api.learningstudio.com'.$api_route;  
	 
	 
	// Define OAuth Parameters
	$oAuthVariables = array(); 
	$oAuthVariables['application_id'] = $application_id; 
	$oAuthVariables['oauth_consumer_key'] = $consumer_key; 
	$oAuthVariables['oauth_nonce'] = $nonce; 
	$oAuthVariables['oauth_signature_method'] = 'CMAC-AES';
	$oAuthVariables['oauth_timestamp'] = time();
	 
	 
	// Create a Signable String
	// If this is a POST or PUT we tack on the body as a parameter 
	// *only* for the signable string. The body is base64 encoded, and then 
	// url-encoded TWICE. 
	$signable_string = $method.'&'.urlencode($api_route).'&'; 
	 
	$StringParts = $oAuthVariables; 
	if($method=='POST' || $method=='PUT')                               
		$StringParts['body'] = urlencode(urlencode(base64_encode($post_body))); 
	 
	ksort($StringParts); 
	 
	$encodable = array(); 
	 
	foreach($StringParts as $key=>$value){ 
		$encodable[] = $key.'='.$value; 
	} 
	 
	$signable_string.=urlencode(implode('&',$encodable)); 
	 
	 
	// Get a Signature for the string. Signature is an AES-CMAC hash.
	$CMACEngine = new CryptLib\MAC\Implementation\CMAC;
	// $CMACEngine = new CryptLib\\MAC\\Implementation\\CMAC;
	 
	$packed_string = ''; 
	$stringlength = strlen($signable_string); 
	for($i=0; $i<$stringlength; $i++) { 
	    $packed_string .= pack("c", ord(substr($signable_string, $i, 1))); 
	} 		
	//dsm($packed_string, 'packed string'); 
	$binary_cmac = $CMACEngine->generate($packed_string,$consumer_secret); 
	//dsm($binary_cmac, 'binary cmac');
	
	$signature = base64_encode($binary_cmac);
	//dsm($signature, 'siggy');
	//return; 
	 
	// Create the OAuth HTTP Header 
	$header_vars = array('realm'=>$request_url); 
	$header_vars = array_merge($header_vars,$oAuthVariables); 
	$header_vars['oauth_signature'] = $signature; 
	 
	$header_parts = array(); 
	foreach($header_vars as $k=>$v){ 
		$v = ($k=='realm')?$v:urlencode($v); 
		$header_parts[] = $k.'="'.$v.'"'; 
	} 
	 	
	$oauth_http_header = "X-Authorization: OAuth ".implode(',',$header_parts);
	 	 
	// Use cURL to make the request 
	$ch = curl_init();
	curl_setopt($ch, CURLOPT_URL, $request_url);
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
	curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false); // used to be 0 and worked
	curl_setopt($ch, CURLOPT_USERAGENT, 'Mozilla/5.0 (Windows; U; MSIE 9.0; WIndows NT 9.0; en-US)'); 
	curl_setopt($ch, CURLOPT_CUSTOMREQUEST, $method);
	if ($ct_urlenc){
		// add "Content-Type: application/x-www-form-urlencoded" to header as well
		curl_setopt($ch, CURLOPT_HTTPHEADER, array('Content-Type: application/x-www-form-urlencoded', $oauth_http_header));
	} else {
		curl_setopt($ch, CURLOPT_HTTPHEADER, array($oauth_http_header));
	}
	 
	if($method=='POST' || $method=='PUT')
		curl_setopt($ch, CURLOPT_POSTFIELDS, $post_body);
	 	 
	// Execute & get variables
	$api_response = curl_exec($ch);
	$curlError = curl_error($ch);
	$info = curl_getinfo($ch); 
	$http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
	 
	// Test if there was a cURL problem (request didn't go through)
	if($curlError){
	 	 watchdog('pearson_mp', $curlError . " - There was a problem making the API Call. cURL problem", NULL, WATCHDOG_CRITICAL);
		 //dsm($curlError, "There was a problem making the API Call. cURL problem"); 
	 
	// Test if there is a 4XX error (request went through but erred). 
	} else if(intval($http_code / 100) >=4){
	 
		$decoded = json_decode($api_response); 
		$msg = (is_object($decoded) && isset($decoded->error->message))?$decoded->error->message:"No message reported.";
		$msg.= " Error ID: "; 
		$msg.= (is_object($decoded) && isset($decoded->error->errorId) && !empty($decoded->error->errorId))?$decoded->error->errorId:'None provided';  
	 	@watchdog('pearson_mp', $msg . " - The API Server responded with ".$http_code.". Message was:".$info." route:". $route, NULL, WATCHDOG_CRITICAL);
		//dsm($msg, "The API Server responded with ".$http_code.". Message was:"); 
	 	return 'error, see log ' . $msg . " - The API Server responded with ".$http_code . " route:". $route;
	// Else you have a successful response. 
	} else {
		// return $api_response;
		$decoded_response = $api_response; // redundant, but oh well, must move fast
		if ($jsonEncode) $decoded_response = json_decode($api_response); 
		// dsm($decoded_response);
		return $decoded_response;		
	}	
}

// $item will be an individual course for the term
/* $item->id, 
		->displayCourseCode
 * 		->title
 * 		->callNumbers (array)
 * 		->links (array)
 * 			0->href
 * 			 ->rel
 */
function PearsonUpdateOrAdd($item){
	// This essentially has each item that looks like what is returned from 
	//dsm($item, 'item in the actual worker function');
	
	// see if we have a node with that Pearson ID (not Drupal nid, or Node ID)
	// if so, return the nid, if not, return blank
	$findCourseID = $item->id;
		
	$query = db_select('node', 'n');
	$query->join('field_data_field_pearson_course_number', 'b', 'n.nid = b.entity_id');
	$query
	  ->fields('n', array('nid', 'vid'))
	  ->condition('n.type', 'pearson_course')
	  ->condition('b.field_pearson_course_number_value', $findCourseID);
	$result = $query->execute()->fetchAll();
	
	//see if there is hash info
	$isNewInfo = newHashedInfo('course', $findCourseID, $item); // $item is NOT serialized, done so in function
	

	
	// if there's no new info - hash is same - then let's get out of here
	
	//TODO think i can remove the if block below
	// if ($findCourseID == '8930875'){
		// // debugging
		// $serialItem = serialize($item);
		// $computedHash = hash("crc32b", $serialItem);
		// watchdog('db', 'computed for mine is ' . $computedHash . ' - ' . $isNewInfo . 'end');		
		// // watchdog('db', 'this one');
	// }
	// this block structured this way becuase I recall trouble using || and negatives. can return to later, this will work
	if (!empty($result)){ // if that course already exists
		if ($isNewInfo == FALSE){ // and the hashes are the same
			return;
		}		
	}
	//TODO think i can remove the if block below
	// if ($findCourseID == '8930875'){
		// watchdog('db', 'made it past');
	// }
	// begin - add users	
	  // we'll be using this below to add users to a course
	  $item->entity_reference = array(); 
	  
	  // get the User Enrollment information on this course
	  $remoteUsersForCourse = remoteOAuth1('/courses/' . $findCourseID . '/enrolledUsers');
	  // loop through, adding to queue, and also adding person to parent foreach, so we can reference them in the course node later		  
	  if (is_array($remoteUsersForCourse->enrolledUsers)){
	  	foreach ($remoteUsersForCourse->enrolledUsers as $user) {
	  		//dsm($user, 'user');
	  		//dsm($user->user->firstName, 'fname');
			// $queueUsersInCourses->createItem($user);
			
			// attach Pearson UID to the course information				
			$item->entity_reference[] = $user;			
			
		}
	  }	
	// end - add users	  
	
	//dsm($result, 'result from trying to fetch course id ' . $findCourseID);
		
		  			
	$newNode = (object) NULL;
	$newNode->type = 'pearson_course';
	$newNode->uid = 1;
	$newNode->changed = strtotime("now");
	$newNode->status = 1;
	$newNode->comment = 0;
	$newNode->promote = 0;
	$newNode->moderate = 0;
	$newNode->sticky = 0;
	$newNode->language = 'und';

	$newNode->field_pearson_course_number[LANGUAGE_NONE][0]['value'] = $findCourseID;
	$newNode->field_pearson_course_code[LANGUAGE_NONE][0]['value'] = $item->displayCourseCode;
	$newNode->title = $item->title;
	
	// call numbers
	for ($i=0; $i < count($item->callNumbers); $i++) { 
		$newNode->field_pearson_call_numbers[LANGUAGE_NONE][$i]['value'] = $item->callNumbers[$i];	
	}
	// links
	for ($i=0; $i < count($item->links); $i++) { 
		$newNode->field_pearson_links[LANGUAGE_NONE][$i]['value'] = $item->links[$i]->href;
	}
	
	// TODO: add all the entity references stored in (i think) $item->entity_reference (array)
	$i = 0;
	foreach ($item->entity_reference as $user) {		
		$drupalUID = PearsonUpdateOrAddUser($user, $findCourseID); // returns the drupal UID
		$newNode->field_pearson_course_users[LANGUAGE_NONE][$i]['target_id'] = $drupalUID; // add this to the entity reference for course
		$newNode->field_pearson_course_users[LANGUAGE_NONE][$i]['target_type'] = 'user'; // required
		$i++; // iterate
	}
	
	// if we are updating this node (if the Course ID already exists in the system)
	if (!empty($result)){
		//TODO: this is where we update the course node, but need to check and make shashes
		// we're updating this node
		//dsm('not empty');
		
		$newNode->nid = $result[0]->nid;
		$newNode->vid = $result[0]->nid; // will throw notice without this line
		
		// $newNode->is_new = FALSE;
	} else {
		// we're creating this node
		$newNode->created = strtotime("now");	
		$newNode->is_new = TRUE;
		
	}	
	
	node_save($newNode);	
	
	// add/update hash
	$serialItem = serialize($item);
	// $computedHash = hash("crc32b", $item);
	$computedHash = hash("crc32b", $serialItem);
	_add_hash('course', $findCourseID, $computedHash, $item);	
	
	// if this is the last one to update according to the variable, set it back to false (see hook_cron for more info)
	if ($item->id == variable_get('pearson updateCourseInfo FinalID')){
		variable_set('pearson updateCourseInfo FinalID', '');		
		variable_set('pearson updateCourseInfo', FALSE);
		watchdog('pearson_mp', 'Updated final course');		
	}	
}

// returns UID of the newly created, or already existing user that's passed in as a parameter
function PearsonUpdateOrAddUser($item2, $courseID){
	// see if the user has a Drupal account
	// $debug1 = serialize($item2);
	// watchdog('pearson_mp', $debug1);
	$query = db_select('users', 'u');
	$query->join('field_data_field_pearson_user_id', 'p', 'u.uid = p.entity_id');
	$query
		->fields('u', array('uid'))
		->condition('p.field_pearson_user_id_value', $item2->id);
	$result = $query->execute()->fetchAll();
	
	// now we need to figure out the pearson userName for this person
	$userInfo = remoteOAuth1('/users/' . $item2->id);
	$userName = '';
	if (is_object($userInfo)){
		// grab the userName provided by Pearson
		$userName = $userInfo->users[0]->userName;
	}
	
	// find out which roles to apply
	// 823 => PROF
	// 430 => TAST
	// 916 => STUD
	// watchdog('pearson_mp', 'setting initial auth role');
	$role = array(DRUPAL_AUTHENTICATED_RID => 'authenticated user');
	switch ($item2->role->id) {
		case '823':
			// watchdog('pearson_mp', 'setting prof');
			$role[variable_get('Pearson Professor')] = 'Pearson Professor';
			break;
		case '430':
			// watchdog('pearson_mp', 'setting ta');
			$role[variable_get('Pearson TA')] = 'Pearson TA';
			break;
		case '916':
		// watchdog('pearson_mp', 'setting student');
			$role[variable_get('Pearson Student')] = 'Pearson Student';
			break;
	}

	
	
	if (empty($result)){
		// make sure the name does not conflict (name column in users table is key)
		$query2 = db_select('users', 'u');
		$query2->fields('u', array('name'))->condition('u.name', $item2->user->firstName . ' ' . $item2->user->lastName);
		$existingNames = $query2->execute()->fetchAll();
		$delta = '';
		if (!empty($existingNames)){
			$delta = count($existingNames) + 1;
		}
		
		// we create a new user using user_save API
			// TODO: add specific roles automatically
		  $password = user_password(8);		 
		  //set up the user fields
		  $fields = array(
		    'name' => $item2->user->firstName . ' ' . $item2->user->lastName . $delta,
		    'mail' => $item2->user->emailAddress,
		    'pass' => $password,
		    'status' => 1,
		    'init' => 'email address',
		    'roles' => $role,
		    'field_pearson_user_id' => array(LANGUAGE_NONE => array(0 => array('value' => $item2->id))),
		    'field_pearson_username' => array(LANGUAGE_NONE => array(0 => array('value' => $userName))),
		  ); 
		 
		  //the first parameter is left blank so a new user is created
		  watchdog('pearson_mp', 'Creating new user ' . $item2->user->firstName . ' ' . $item2->user->lastName . ' (' . $userName . ') for course ' . $courseID . ' delta is ' . $delta);
		  $account = user_save('', $fields);
		  return $account->uid;	// uid of the newly created user
	} else {
		// TODO: revisit this, where we can update values, doesn't seem that important right now
			// we can choose to update the user information
			// TODO: add check to see if they have a setting flagged (not yet on settings page)
					
		  // $account = user_load($result[0]->uid);
// 		
		  // $fields = array(
		    // 'name' => $item2->user->firstName . ' ' . $item2->user->lastName,
		    // 'roles' => $role,
		    // 'field_pearson_user_id' => array(LANGUAGE_NONE => array(0 => array('value' => $item2->id))),
		  // ); 
// 		 
		  // // updates the user
		  // watchdog('pearson_mp', 'Updating user ' . $item2->user->firstName . ' ' . $item2->user->lastName . ' for course ' . $courseID);
		  // user_save($account, $fields);				
		
		  return $result[0]->uid; // this is the uid of the existing user					
	}		
}


function pearson_mp_form_alter(&$form, &$form_state, $form_id){
	// dsm($form, 'form');
	// dsm($form_id, 'form_id');
} 

function pearson_mp_form_user_profile_form_alter(&$form, &$form_state){
	// dsm(_decryptFromUID(1));
	// the below used to do the encryption
	$form['#validate'][] = '_profile_submit'; // see if phone number is correct
}

function pearson_mp_form_pearson_goal_node_form_alter(&$form, &$form_state){
	// dsm($form, 'form');
	// dsm($_GET, 'get');
	
	// see if this is an EDIT or a NEW node being created
	if (empty($form['nid']['#value'])){
		// new node being created
		$userObj = user_load($_GET['goal_user']);
		$courseObj = node_load($_GET['goal_course']);
		
		// dsm($userObj, 'user obj');
		// dsm($courseObj, 'course obj');
		
		$form['title']['#default_value'] = 'Goal: ' . $userObj->name . ' for ' . $courseObj->field_pearson_course_code[LANGUAGE_NONE][0]['value'];
		$form['field_pearson_goal_course'][LANGUAGE_NONE][0]['target_id']['#default_value'] = $courseObj->title . " ({$courseObj->nid})"; // add this to the entity reference for course	
		$form['field_pearson_goal_user'][LANGUAGE_NONE][0]['target_id']['#default_value'] = $userObj->name . " ({$userObj->uid})"; // add this to the entity reference for course			
	}
	$form['field_pearson_goal_user']['#disabled'] = TRUE; // add this to the entity reference for course
	$form['field_pearson_goal_course']['#disabled'] = TRUE; // add this to the entity reference for course
}

function _profile_submit(&$form, &$form_state){
	// dsm($form, 'form');
	// dsm($form_state, 'fs');
	
	// check to see if phone number is 10 characters long and numeric
	$phone = $form_state['values']['field_pearson_user_phone'][LANGUAGE_NONE][0]['value'];
	$isBroken = FALSE;
	if (!is_numeric($phone)) $isBroken = TRUE;
	if (strlen($phone) != 10) $isBroken = TRUE;
	if (empty($phone)) $isBroken = FALSE; // otherwise it's essentially a required field.
	
	if ($isBroken){
		form_set_error('field_pearson_user_phone', 'Please enter a valid 10-digit phone number like 8085551234');
	}
	
	// dsm($form_state, 'fs');
	// kept commented out in case I want to use encryption later
	// $enc = encrypt($form_state['values']['field_pearson_prof_password'][LANGUAGE_NONE][0]['value']);
	// $form_state['values']['field_pearson_prof_password'][LANGUAGE_NONE][0]['value'] = bin2hex($enc);
}

/*
 * good idea of how to use encryption, although not needing it now
function _decryptFromUID($uid, $role){
	$query = db_select('users', 'u');
	$query->join('field_data_field_pearson_prof_password', 'f', 'u.uid = f.entity_id');
	$query->fields('f', array('field_pearson_prof_password_value'));
	$result = $query->execute()->fetchAll();
	$bin = hex2bin($result[0]->field_pearson_prof_password_value);
	$dec = decrypt($bin);
	return $dec;
}
 */

function remoteOAuth2POSTFile($access){
	// set up header
	$body = 
		'mikedotexe
		Content-Disposition: form-data; name=""; filename="purvis.txt"
		Content-Type: text/plain
		 
		this is the data. aloha.
		mikedotexe';

	$header = 'X-Authorization: Access_Token access_token=' . $access;
	$curl = curl_init();
	
	curl_setopt_array($curl, array(
	    CURLOPT_RETURNTRANSFER => 1,
	    CURLOPT_URL => 'https://api.learningstudio.com/tempfiles',
	    CURLOPT_POST => 1,
	    CURLOPT_POSTFIELDS => $body,
	    CURLOPT_HTTPHEADER => array($header, 'Content-Type: multipart/form-data; boundary=mikedotexe'),
	    CURLOPT_SSL_VERIFYPEER => 0
	));
		 	
	// Execute & get variables
	$api_response = curl_exec($curl);
	$curlError = curl_error($curl);
	$info = curl_getinfo($curl); 
	$http_code = curl_getinfo($curl, CURLINFO_HTTP_CODE);
	curl_close($curl);	
	 
	// Test if there was a cURL problem (request didn't go through)
	if($curlError){
	 	 watchdog('pearson_mp', $curlError . " - There was a problem making the API Call. cURL problem in remoteOAuth2POSTFile", NULL, WATCHDOG_CRITICAL);
	// Test if there is a 4XX error (request went through but erred). 
	} else if(intval($http_code / 100) >=4){
	 
		$decoded = json_decode($api_response); 
		$msg = (is_object($decoded) && isset($decoded->error->message))?$decoded->error->message:"No message reported.";
		$msg.= " Error ID: "; 
		$msg.= (is_object($decoded) && isset($decoded->error->errorId) && !empty($decoded->error->errorId))?$decoded->error->errorId:'None provided';  
	 	watchdog('pearson_mp', $msg . " - The API Server responded with ".$http_code.". Found in remoteOAuth2POSTFile", NULL, WATCHDOG_CRITICAL);
	// Else you have a successful response. 
	} else {	 
		$decoded_response = json_decode($api_response); 
		// dsm($decoded_response);  
		return $decoded_response;
	}
}

function remoteOAuth2GET($accessToken, $route, $decode = TRUE){
	// set up header
	$header = 'X-Authorization: Access_Token access_token=' . $accessToken;
	$curl = curl_init();
	
	curl_setopt_array($curl, array(
	    CURLOPT_RETURNTRANSFER => 1,
	    CURLOPT_URL => 'https://api.learningstudio.com' . $route,
	    CURLOPT_HTTPHEADER => array('Content-Type: application/x-www-form-urlencoded', $header),
	    CURLOPT_SSL_VERIFYPEER => 0
	));
		 	
	// Execute & get variables
	$api_response = curl_exec($curl);
	$curlError = curl_error($curl);
	$info = curl_getinfo($curl); 
	$http_code = curl_getinfo($curl, CURLINFO_HTTP_CODE);
	curl_close($curl);	
	 
	// Test if there was a cURL problem (request didn't go through)
	if($curlError){
	 	 watchdog('pearson_mp', $curlError . " - There was a problem making the API Call. cURL problem in remoteOAuth2GET . ", NULL, WATCHDOG_CRITICAL);
	// Test if there is a 4XX error (request went through but erred). 
	} else if(intval($http_code / 100) >=4){
	 
		$decoded = json_decode($api_response); 
		$msg = (is_object($decoded) && isset($decoded->error->message))?$decoded->error->message:"No message reported.";
		$msg.= " Error ID: "; 
		$msg.= (is_object($decoded) && isset($decoded->error->errorId) && !empty($decoded->error->errorId))?$decoded->error->errorId:'None provided';  
	 	watchdog('pearson_mp', $msg . " - The API Server responded with ".$http_code.". Found in remoteOAuth2GET", NULL, WATCHDOG_CRITICAL);
		return $msg . ' ' . $http_code;
	// Else you have a successful response. 
	} else {	 
		$decoded_response = json_decode($api_response); 
		// dsm($decoded_response);  
		if ($decode == TRUE)  
			return $decoded_response;
		else
			return $api_response;
	}
}

function remoteOAuth2POST($access, $route, $body){
	// set up header
	// watchdog('findthis', 'trying with body of ' . $body, NULL, WATCHDOG_CRITICAL);

	$header = 'X-Authorization: Access_Token access_token=' . $access;
	$curl = curl_init();
	
	curl_setopt_array($curl, array(
	    CURLOPT_RETURNTRANSFER => 1,
	    CURLOPT_URL => 'https://api.learningstudio.com' . $route,
	    CURLOPT_POST => 1,
	    CURLOPT_POSTFIELDS => $body,
	    CURLOPT_HTTPHEADER => array($header, 'Content-Type: application/json; charset=utf-8'),
	    CURLOPT_SSL_VERIFYPEER => 0
	));
		 	
	// Execute & get variables
	$api_response = curl_exec($curl);
	$curlError = curl_error($curl);
	$info = curl_getinfo($curl); 
	$http_code = curl_getinfo($curl, CURLINFO_HTTP_CODE);
	curl_close($curl);	
	 
	// Test if there was a cURL problem (request didn't go through)
	if($curlError){
	 	 watchdog('pearson_mp', $curlError . " - There was a problem making the API Call. cURL problem in remoteOAuth2POST", NULL, WATCHDOG_CRITICAL);
	// Test if there is a 4XX error (request went through but erred). 
	} else if(intval($http_code / 100) >=4){
	 
		$decoded = json_decode($api_response); 
		$msg = (is_object($decoded) && isset($decoded->error->message))?$decoded->error->message:"No message reported.";
		$msg.= " Error ID: "; 
		$msg.= (is_object($decoded) && isset($decoded->error->errorId) && !empty($decoded->error->errorId))?$decoded->error->errorId:'None provided';  
	 	watchdog('pearson_mp', $msg . " - The API Server responded with ".$http_code.". Found in remoteOAuth2POST", NULL, WATCHDOG_CRITICAL);
	// Else you have a successful response. 
	} else {	 
		$decoded_response = json_decode($api_response); 
		// dsm($decoded_response);  
		return $decoded_response;
	}
}

function remoteOAuth2GETAssertion($uname){
	// get username and decrypted password, then get token, then make request TODO: can get rid of this, but may want to use it later
	// $query = db_select('users', 'u');
	// $query->join('field_data_field_pearson_username', 'f', 'u.uid = f.entity_id');
	// $query->fields('f', array('field_pearson_username_value'))->condition('u.uid', $uid);
	// $result = $query->execute()->fetchAll();
// 	
	// if (empty($result)){
		// watchdog('pearson_mp', 'Could not find username for user with id ' . $uid, NULL, WATCHDOG_CRITICAL);
		// return;
	// }
		
	$eCMAC = new CryptLib\MAC\Implementation\ECollegeCMAC; 
  
	//Set up variables for creating the assertion
	$application_id   = variable_get('pearson_app_id');    //Your Application's ID/Key. Use for all campuses.
	$key_moniker      = variable_get('pearson_consumer_key');;  //Campus-specific 
	$secret_key       = variable_get('pearson_consumer_secret');     //Campus-specific
	$client_string    = variable_get('pearson_client_string');     //Campus-specific
	$application_name = $client_string;       //This data point isn't checked, so we go simple
	$username 	      = $uname; //$result[0]->field_pearson_username_value;         // User's username in LearningStudio
	$timestamp 	      = str_replace('+00:00','Z',gmdate('c')); //This format is important
	 
	 
	//Set up variables needed to make the request of the API 
	$api_url       = "https://api.learningstudio.com/token";
	$grantType 	   = "assertion";
	$assertionType = "urn:ecollege:names:moauth:1.0:assertion"; 
	 
	//Assemble the Assertion string following this pattern (see documentation for details)
	//$assertion = '{client_name}|{key_moniker}|{client_id}|{client_string}|{username}|{timestamp}';
	$assertion = "$application_name|$key_moniker|$application_id|$client_string|$username|$timestamp";
	 
	// Now get the CMAC hash of the assertion (the signature)
	try{
	 
		//Pass Assertion and Key to the generateEcollegeCMAC method. 
		//This assumes the Assertion string has NOT been binary encoded. This method will pack() the 
		//string for you, hash it, and then bin2hex it. 
		$cmac = $eCMAC->generateECollegeCMAC($assertion,$secret_key); 
	 
		//$cmac is now equal to something like 989d5631fc2a4cd831ba84e6c7d39478
	 
	} catch(Exception $e){ 
		exit($e->getMessage());  
	} 
	 
	//Append the signature hash to the Assertion 
	$assertion .= '|'.$cmac; 
	 
	//Set up the body of the POST request
	$post_fields = "grant_type=".$grantType."&assertion_type=".$assertionType."&assertion=".$assertion;  
	 
	//Set up cURL Transaction
	$ch = curl_init();
	curl_setopt($ch, CURLOPT_URL, $api_url);
	curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
	curl_setopt($ch, CURLOPT_CUSTOMREQUEST, "POST");
	curl_setopt($ch, CURLOPT_POSTFIELDS, $post_fields);
	curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false); // used to be 0 and worked
	 
	//execute & get server response;
	$api_response = curl_exec($ch); 
	 
	//capture errors or other status codes
	$curl_error = curl_error($ch);
	$http_code = curl_getinfo($ch, CURLINFO_HTTP_CODE);
	 
	// Test if there was a cURL problem (request didn't go through)
	if($curl_error){	
		watchdog('pearson_mp', "There was a problem making the API Call. cURL problem: $curl_error", NULL, WATCHDOG_CRITICAL); 	 
	// Test if there is a 4XX error (request went through but erred). 
	} else if(intval($http_code / 100) >=4){	 
		$decoded_response = json_decode($api_response); 
		$msg = (is_object($decoded_response) && isset($decoded_response->error->message))?$decoded_response->error->message:"No message reported."; 
		watchdog('pearson_mp', "[remoteOAuth2GETAssertion] The API Server responded with ".$http_code.". Message was: $msg", NULL, WATCHDOG_CRITICAL);
	 
	// Else you have a successful response. 
	} else {
	 
		$decoded_response = json_decode($api_response); 
		$access_token = $decoded_response->access_token; 
		$expires_in = $decoded_response->expires_in; // seconds 
	 
		// echo "<b>Access Token:</b> $access_token<br /><br />"; 
		// echo "<b>Expires In:</b> $expires_in<br /><br />"; 
		return $decoded_response;	 
	}	
}


function _debug_mp($arg = NULL){
	return '<h1>here and also</h1> some ' . $arg . ' the end';
}

function _mpProf($form, &$form_state) {
  $prof_id = arg(3); //(empty(arg(3))) ? '' : arg(3);
  dsm($prof_id, 'prof_id');
  
  $form['description'] = array(
    '#type' => 'item',
    '#title' => t('Enter the Name and ID of a Professor'),
  );
  // This is the first form element. It's a textfield with a label, "Name"
  $form['name'] = array(
    '#type' => 'textfield',
    '#title' => t('Name'),
  );
  // _mpcurl(19, 'professor');
  _mpcurl();
  return $form;
}

function _mpcurl($id = NULL, $type = NULL){
	$apikey = get_api_key();
	dsm($apikey, 'API Key');
	
	if (isset($id)) dsm($id, 'id');	
	if (isset($type)) dsm($type, 'type');
	
	$curl_handle = curl_init();  
	curl_setopt_array($curl_handle, array(
		CURLOPT_URL => 'http://www.mikedotexe.com/index.php/app/plants',
	    CURLOPT_RETURNTRANSFER => 1,
	    CURLOPT_POST => 0,
	));

	
	// Optional, delete this line if your API is open  
	// curl_setopt($curl_handle, CURLOPT_USERPWD, $username . ':' . $password);  	
	
	$buffer = curl_exec($curl_handle);  
	curl_close($curl_handle);  
	  
	$result = json_decode($buffer);  
	dsm($result, 'result');
	return $result;
}

function _import_roles(){
	watchdog('pearson_mp', 'Import user roles...');
	$pearsonRoles = unserialize(PEARSON_ROLES);
	foreach ($pearsonRoles as $role) {
		$r = new stdClass();
		$r->name = $role;
		// if there's no role like this one yet
		if (!roleExists($role)) user_role_save($r);
		
		// let's store the role ID as a variable so we don't have to memorize or hack it
		$rid = setVarForRole($role);
		$r_perms = array('pearson see all students' => TRUE);
		// $r_perms = array();
		//$r_perms[] = array('pearson see all students' => TRUE); // everyone gets this by default
		if ($role == 'Pearson Professor') $r_perms = array_merge($r_perms, array('pearson see all grades' => TRUE)); // only professor gets this
		user_role_change_permissions($rid, $r_perms);  
	}	
}

// tied to _import_roles
function setVarForRole($name){
	$query = db_select('role', 'r');
	$query
		->fields('r', array('rid'))
		->condition('r.name', $name);
	$result = $query->execute()->fetchAll();
	// sets the variable	
	variable_set($name, $result[0]->rid);
	return $result[0]->rid;
	//dsm($result, 'res');		
}

// tied to _import_roles
function roleExists($name){
	$query = db_select('role', 'r');
	$query
		->fields('r', array('rid'))
		->condition('r.name', $name);
	$result = $query->execute()->fetchAll();
	// sets the variable	
	if (empty($result)) return false;
	return true;
}

/* called from .install 
 *TODO: unfinished 
 * */

function _import_bundles(){
	watchdog('pearson_mp', 'Import bundles...');
	$path = drupal_get_path('module', 'pearson_mp') . '/bundles';
	$dir = new DirectoryIterator($path);
	// dsm($path, 'dir');
	foreach ($dir as $fileinfo) {// loop through each file in the directory
		if (!$fileinfo->isDot()) { // make sure its not . (current directory) or .. (parent directory)
			$filename = $fileinfo->getFilename();
			$contents = file_get_contents($path . '/' . $filename);
			// dsm($filename, 'filename');
			// dsm($contents, 'c');
			
			if (function_exists('bundle_copy_import_submit')){ // function that bundle copy uses to import
				$form = array();
				$form_state = array();
				$form_state['values']['macro'] = $contents;
				// for these imports, work gets done in the _validate and _submit functions to do the actual import
				bundle_copy_import_submit('', $form_state); // function doesn't use first arg
				watchdog('pearson_mp', 'Imported ' . $filename);
			}else{
				$error = 'No bundle_copy_import_submit function found, bundle installation cannot proceed.';
				watchdog('pearson_mp', $error, NULL, WATCHDOG_CRITICAL);
				dsm($error);
			}	 			
		}
	}
}

/* called from .install 
 * Imports all rules defined in the /rules folder 
 * */

function _import_rules(){
	// basically I'll be mimicking functionality in the import function, check to make sure it exists, for good measure
	module_load_include('inc', 'rules', 'ui/ui.forms'); // otherwise it can't see the file
	
	watchdog('pearson_mp', 'Import rules...');
	$path = drupal_get_path('module', 'pearson_mp') . '/rules';
	$dir = new DirectoryIterator($path);
	// dsm($path, 'dir');
	foreach ($dir as $fileinfo) {// loop through each file in the directory
		if (!$fileinfo->isDot()) { // make sure its not . (current directory) or .. (parent directory)
			$filename = $fileinfo->getFilename();
			$contents = file_get_contents($path . '/' . $filename);
			// dsm($filename, 'filename');
			// dsm($contents, 'c');
			
			if (function_exists('rules_ui_import_form_validate')){ // function that bundle copy uses to import
				$form = array();
				$form_state = array();
				$form_state['values']['import'] = $contents;
				$form_state['values']['overwrite'] = 1;
				
				// for these imports, work gets done in the _validate and _submit functions to do the actual import
				rules_ui_import_form_validate($form, $form_state);
				rules_ui_import_form_submit($form, $form_state);
				watchdog('pearson_mp', 'Imported ' . $filename);
			}else{
				$error = 'No rules_ui_import_form_validate function found, rules installation cannot proceed.';
				watchdog('pearson_mp', $error, NULL, WATCHDOG_CRITICAL);
				// dsm($error);
			}	 			
		}
	}
}

function pearson_mp_user_view($account, $view_mode, $langcode){
	drupal_add_library('system', 'drupal.collapse');
	drupal_add_js('misc/form.js'); // don't know if its really required to collapsible fieldsets to work
	drupal_add_js('misc/collapse.js');	
	// dsm($account, 'account');
	$roles = $account->roles;
	unset($roles[2]);
	$printedRoles = implode(', ', $roles);
	$isStudent = FALSE;
	if (in_array('Pearson Student', $roles)) $isStudent = TRUE;
	// dsm(arg(1));
	
	$account->content['role'] = array(
	 '#type' => 'markup',
	 '#markup' => "<h3>Role(s): $printedRoles</h3>",
	);
	$links = array();
	$fromSettings = variable_get('names_fieldset');
	// dsm($fromSettings, 'fs');
	if (!empty($fromSettings)){
		// there are links to add
		for ($i=0; $i < count($fromSettings['pearson_linkdesc']); $i++) { 
			$links[] = l($fromSettings['pearson_linkdesc'][$i], $fromSettings['pearson_link'][$i], array('attributes' => array('target' => '_blank')));
		}
		$bred = implode('<br/>', $links);
		$account->content['common_links'] = array(
		 '#type' => 'markup',
		 '#markup' => "<h3>Common Link(s):</h3> $bred<hr/>",
		);
	}
	
	// $origAccount = $account->content;
	
	// add header
	$account->content['view'] = array(
	 '#type' => 'markup',
	 '#weight' => 99,
	 '#markup' => '<h1>Courses</h1>',
	);	
	
	// find all classes associated with this user, embed views for each
	$classIDs = classesByUID(arg(1));
	for ($i=0; $i < count($classIDs); $i++) {
		$view = views_embed_view('pearson_course', 'page', $classIDs[$i]->entity_id);
		$annView = views_embed_view('pearson_announcements', 'page', $classIDs[$i]->entity_id);
		// dsm($annView, '$annView');

		
		$classNode = node_load($classIDs[$i]->entity_id);
		// dsm($classNode, 'classNode');
		$pearsonCID = $classNode->field_pearson_course_number[LANGUAGE_NONE][0]['value'];
		$pearsonCC = $classNode->field_pearson_course_code[LANGUAGE_NONE][0]['value'];
		$pearsonUname = $account->field_pearson_username[LANGUAGE_NONE][0]['value'];
		$pearsonUID = $account->field_pearson_user_id[LANGUAGE_NONE][0]['value'];
		
		// $view .= l('Course Entry for ' . $pearsonCC, 'course-entry', array('query' => array('UserID' => $pearsonUID, 'UserName' => $pearsonUname, 'CourseID' => $pearsonCID), 'html' => TRUE, 'attributes' => array('target' => '_blank', 'class' => 'clearfix')));
		global $base_url;
		$img = '<div class="floatright"><img src="' . $base_url. '/sites/all/themes/danland/images/uhh/courseentry-wide200.png" alt="Enter Course"/><br/>';		
		$view .= l($img, 'course-entry', array('query' => array('UserID' => $pearsonUID, 'UserName' => $pearsonUname, 'CourseID' => $pearsonCID), 'html' => TRUE, 'attributes' => array('target' => '_blank', 'alt' => 'Enter Course', 'class' => array('courseentry'))));
		// add link to see syllabus
		$syllabusImg = '<img src="' . $base_url. '/sites/all/themes/danland/images/uhh/syllabus200.png" alt="View Syllabus"/>';
		$view .= l($syllabusImg, 'syllabus', array('query' => array('CourseID' => $pearsonCID), 'html' => TRUE, 'attributes' => array('target' => '_blank', 'alt' => 'View Syllabus', 'class' => array('viewsyllabus'))));
		$view .= '</div>'; // closes floatright div
		
		if (strpos($annView, 'view-content')){
			// we have results
			$view .= '<h3>Announcement(s)</h3>' . $annView;
		} else{
			$view .= '<h3>No Announcements</h3>';
		}
		
		// add ajax link to create goal
		
		
		// add link to create goal
		if ($isStudent){
			// see if they have a goal node attached to them
			$query = db_select('users', 'u');
			$query->join('field_data_field_pearson_goal_user', 'x', 'u.uid = x.field_pearson_goal_user_target_id');
			$query->join('node', 'n', 'x.entity_id = n.nid');
			$query->join('field_data_field_pearson_goal_percent', 'p', 'n.nid = p.entity_id');
			$query->join('field_data_field_pearson_goal_course', 'c', 'n.nid = c.entity_id');
			$query->fields('p', array('field_pearson_goal_percent_value', 'entity_id'))->condition('u.uid', $account->uid)->condition('c.field_pearson_goal_course_target_id', $classNode->nid);
			$results = $query->execute()->fetchAll();
						
			  ctools_include('ajax');
			  ctools_include('modal');
			
			  // Add CTools' javascript to the page.
			  ctools_modal_add_js();	
			  // Create our own javascript that will be used to theme a modal.
			  $sample_style = array(
			    'ctools-sample-style' => array(
			      'modalSize' => array(
			        'type' => 'fixed',
			        'width' => 500,
			        'height' => 300,
			        'addWidth' => 20,
			        'addHeight' => 15,
			      ),
			      'modalOptions' => array(
			        'opacity' => .5,
			        'background-color' => '#000',
			      ),
			      'animation' => 'fadeIn',
			      'modalTheme' => 'CToolsSampleModal',
			      'throbber' => theme('image', array('path' => ctools_image_path('ajax-loader.gif', 'ctools_ajax_sample'), 'alt' => t('Loading...'), 'title' => t('Loading'))),
			    ),
			  );
			
			  drupal_add_js($sample_style, 'setting');	
			  
			  ctools_add_js('ctools-ajax-sample', 'ctools_ajax_sample');
			  ctools_add_css('ctools-ajax-sample', 'ctools_ajax_sample');							
			
			$view .= '<h3>Goal</h3>';

			
			$goal = '';
			$goalLink = '';
			if (empty($results)){
				// they HAVE NO goal, give link to set goal
				// $goalLink = l('Set goal!', 'node/add/pearson-goal', array('query' => array('goal_user' => $account->uid, 'goal_course' => $classNode->nid), 'attributes' => array('target' => '_blank')));
				$goalLink = ctools_modal_text_button(t('Set goal!'), "pearson_mp/nojs/animal/{$account->uid}/{$classNode->nid}", t('Set goal'),  'ctools-modal-ctools-sample-style');
				$container = theme('pearson_goal_container', array('content' => $goalLink, 'nid' => $classNode->nid));
			} else {
				// they HAVE a goal, give change link and the value
				$goal = $results[0]->field_pearson_goal_percent_value;
				$nid = $results[0]->entity_id; // TODO: might be able to remove this
 
				// $goalLink = l('Change goal', 'node/' . $nid . '/edit', array('attributes' => array('target' => '_blank'))) . "<span class=\"pearsonBig\">$goal%</span>";
				$goalLink = ctools_modal_text_button(t('Change goal'), "pearson_mp/nojs/animal/{$account->uid}/{$classNode->nid}", t('Set goal'),  'ctools-modal-ctools-sample-style');
				$container = theme('pearson_goal_container', array('content' => "$goalLink <span class=\"pearsonBig\">$goal%</span>", 'nid' => $classNode->nid));
				 								
			}			
			$view .= $container;
		}

		// make fieldset to hold it
		$account->content['course' . $pearsonCID] = array(
			'#type'=>'fieldset',
			// '#title'=>'<h3>' . $classNode->title . '</h3>',
			'#title'=>$classNode->title,
			'#collapsible'=>true,
			'#collapsed'=>false,
			'#weight' => 100,
			  '#attributes' => array (
			    'class' => array(
			      // 'collapsible', 'collapsed'
			    )
			  )			
		);	
		
		// $account->content = drupal_render($account->content);
				
		$account->content['course' . $pearsonCID]['view' . $i] = array(
		 '#type' => 'markup',
		 '#weight' => 100 + $i * 5,
		 '#markup' => $view,
		);
		
		if ($isStudent){
			$together = $pearsonUID . '-' . $pearsonCID;
			ctools_include('ajax');
			// add button to check current grade
			$account->content['course' . $pearsonCID]['grade' . $together] = array(
			 '#type' => 'markup',
			 '#weight' => $account->content['course' . $pearsonCID]['view' . $i]['#weight'] + 2,
			 '#markup' => '<div id="pearsongrade' . $together . '" class="pearsongrade"></div>',
			);			
			$links = array();
			$links[] = ctools_ajax_text_button(t('What\'s my grade?'), "pearson-mp/ajaxgrade/1/" . $pearsonUID . '/' . $pearsonCID, t('Retrieve grade'));
			// dsm($links, 'links');
			$output = theme('item_list', array('items' => $links, 'title' => t('Current grade')));
			$account->content['course' . $pearsonCID]['gradebtn' . $together] = array(
			 '#type' => 'markup',
			 '#weight' => $account->content['course' . $pearsonCID]['view' . $i]['#weight'] + 1,
			 '#markup' => $output,
			);					
		}
	} 
}

function _ajax_grade($js = NULL, $uid, $cid) {
  // dsm($js, 'js');
  // dsm($uid, 'uid');
  // dsm($cid, 'cid');
  // dsm($arg, 'arg');	  
  
  $gradeObj = $a = remoteOAuth1("/users/$uid/courses/$cid/coursegradetodate");
  $items = array();
  if ($gradeObj->courseGradeToDate->shareWithStudent){
	$header = array();
	$rows = array();
	
	$header[] = array("data" => "Category");
	$header[] = array("data" => "Grade");
	
	$rows[] = array("Average", $gradeObj->courseGradeToDate->average . '%'); 
	$rows[] = array("Earned", $gradeObj->courseGradeToDate->earned); 
	$rows[] = array("Possible", $gradeObj->courseGradeToDate->possible); 
	$rows[] = array("Extra Credit", $gradeObj->courseGradeToDate->extraCredit); 
	$rows[] = array("Letter Grade", $gradeObj->courseGradeToDate->letterGrade->letterGrade); 
	$rows[] = array("Comments", $gradeObj->courseGradeToDate->letterGrade->comments);  	
	$html = theme('table', array('header' => $header, 'rows' => $rows));        	
  } else {
  	$items['Sorry'] = 'The grades are not available to you.';
  }
  // $output = '';
  // foreach ($items as $k => $v) {
      // $output .= $k . ': ' . $v . '<br/>';
  // }
  
  // $output = '<h1>' . t('C plus plus for ' . $uid . ' from course ' . $cid) . '</h1>'; 
  
  if ($js) {
    ctools_include('ajax');
    $commands = array();
    $commands[] = ajax_command_html('#pearsongrade' . $uid . '-' . $cid, $html);
    print ajax_render($commands); // this function exits.
    exit;
  }
  else {
    return $output;
  }
}

function pearson_mp_node_view($node, $view_mode){
	// dsm($node, 'node');
	// dsm($view_mode, '$view_mode');
	if ($node->type == 'pearson_course'){
		// add the Announcement view to the bottom
		$view = '<hr/>';
		$annView = views_embed_view('pearson_announcements', 'page', $node->nid);
		if (strpos($annView, 'view-content')){
			// we have results
			$view .= '<h3>Announcement(s)</h3>' . $annView;
		} else{
			$view .= '<h3>No Announcements</h3>';
		}
		$node->content['viewAnn'] = array(
		 '#type' => 'markup',
		 '#weight' => 100,
		 '#markup' => $view,
		);						
	}
	return $node;
}

// returns an array like this: 0->entity_id, 1->entity_id

function classesByUID($uid){
	$query = db_select('users', 'u');
	$query->join('field_data_field_pearson_course_users', 'c', 'u.uid = c.field_pearson_course_users_target_id');
	$query	
		->fields('c', array('entity_id'))
		->condition('u.uid', $uid);
	$results = $query->execute()->fetchAll();
	return $results;
}

function subPearsonCourse(){
	$prin = variable_get('pearson_principal');
	$prin_shared = variable_get('pearson_principal_shared');
	$time = time();
	$tags = 'CourseID:8930875';
	$callbackURL = 'http://www.mikedotexe.com/pearson-ann/announcement';
	
	$StringParts = array('Timestamp' => $time, 'TAGS' => $tags, 'CALLBACK-URL' => $callbackURL); 
	ksort($StringParts); 
	 
	$encodable = array(); 	 
	foreach($StringParts as $key=>$value){ 
		$encodable[] = $key.'='.$value; 
	} 
	 
	$signable_string = urlencode(implode('&',$encodable)); 	 
	 
	// Get a Signature for the string. Signature is an AES-CMAC hash.
	$CMACEngine = new CryptLib\MAC\Implementation\CMAC;
	 
	$packed_string = ''; 
	$stringlength = strlen($signable_string); 
	for($i=0; $i<$stringlength; $i++) { 
	    $packed_string .= pack("c", ord(substr($signable_string, $i, 1))); 
	} 		
	// use Shared Secret to get CMAC
	$binary_cmac = $CMACEngine->generate($packed_string,$prin_shared); 
	
	$signature = base64_encode($binary_cmac);
	// add pipes
	$finalAuthorization = $prin . '|' . $time . '|' . $signature;
	
	$urlVars = array();
	$urlVars['TAGS'] = $tags;
	$urlVars['AUTHORIZATION'] = $finalAuthorization;
	$urlVars['CALLBACK-URL'] = $callbackURL;
	// CamelCase doesn't seem to matter
	// $urlVars['Tags'] = $tags;
	// $urlVars['Authorization'] = $finalAuthorization;
	// $urlVars['CallbackUrl'] = $callbackURL;
	
	ksort($urlVars);
	
	$encodable2= array(); 
	 
	foreach($urlVars as $key=>$value){ 
		$encodable2[] = $key.'='.$value; 
	} 	
	
	$urlVarsWebReady = urlencode(implode('&',$encodable2));
	
	$curl = curl_init();
	
	curl_setopt_array($curl, array(
	    CURLOPT_RETURNTRANSFER => 1,
	    CURLOPT_URL => 'https://prospero.ecollege.com/v1/subscription',
	    CURLOPT_POST => 1,
	    CURLOPT_POSTFIELDS => $urlVarsWebReady,
	    CURLOPT_HTTPHEADER => array('Content-Type: application/x-www-form-urlencoded'),
		CURLOPT_USERAGENT => 'Mozilla/5.0 (Windows; U; MSIE 9.0; WIndows NT 9.0; en-US)', 
	    CURLOPT_SSL_VERIFYPEER => 0,
	));
		 	
	// Execute & get variables
	$api_response = curl_exec($curl);
	$curlError = curl_error($curl);
	$info = curl_getinfo($curl); 
	$http_code = curl_getinfo($curl, CURLINFO_HTTP_CODE);
	curl_close($curl);	
	 
	// Test if there was a cURL problem (request didn't go through)
	if($curlError){
	 	 watchdog('pearson_mp', $curlError . " - There was a problem making the API Call. cURL problem in subPearsonCourse", NULL, WATCHDOG_CRITICAL);
		return 'Error: ' . $curlError;
	// Test if there is a 4XX error (request went through but erred). 
	} else if(intval($http_code / 100) >=4){
	 
		$decoded = json_decode($api_response); 
		$msg = (is_object($decoded) && isset($decoded->error->message))?$decoded->error->message:"No message reported.";
		$msg.= " Error ID: "; 
		$msg.= (is_object($decoded) && isset($decoded->error->errorId) && !empty($decoded->error->errorId))?$decoded->error->errorId:'None provided';  
	 	watchdog('pearson_mp', $msg . " - The API Server responded with ".$http_code.". Found in subPearsonCourse", NULL, WATCHDOG_CRITICAL);
		return 'Error: ' . $msg . ' ' . $http_code;
	} else {	 
		$decoded_response = json_decode($api_response); 
		// dsm($decoded_response);  
		return $decoded_response;
	}	
		
}

function _rule_announcement($node, $update = FALSE){
	// $node = json_decode('{"type":"pearson_announcement","uid":1,"changed":1383943382,"status":1,"comment":0,"promote":0,"moderate":0,"sticky":0,"language":"und","field_pearson_ann_id":{"und":[{"value":29947550}]},"field_pearson_ann_subject":{"und":[{"value":"Extra credit opportunity! "}]},"field_pearson_ann_text":{"und":[{"value":"There is a guest speaker coming in from Microsoft, if you attend youll be able to get 5 points extra credit for a two-paragraph summary of his speech."}]},"field_pearson_ann_submitter":{"und":[{"value":"Kory Manahan"}]},"field_pearson_ann_startdisplayda":{"und":[{"value":"2011-01-19T07:00:00Z","timezone":"Pacific\/Honolulu","timezone_db":"UTC","date_type":"date"}]},"field_pearson_ann_enddisplaydate":{"und":[{"value":"2030-01-01T06:59:00Z","timezone":"Pacific\/Honolulu","timezone_db":"UTC","date_type":"date"}]},"title":"Extra credit opportunity! ","nid":"258","vid":"258","field_pearson_ann_course":{"und":[{"target_id":"227","target_type":"node"}]},"original":{"vid":"258","uid":"1","title":"Extra credit opportunity ","log":"","status":"1","comment":"0","promote":"0","sticky":"0","vuuid":"ad2b7a51-da09-43d5-961d-a2102c0e82fc","nid":"258","type":"pearson_announcement","language":"und","created":"1383942962","changed":"1383942962","tnid":"0","translate":"0","uuid":"c8e5ba90-4524-4577-acd0-663c614ecc81","revision_timestamp":"1383942962","revision_uid":"1","field_pearson_ann_enddisplaydate":{"und":[{"value":"2030-01-01T06:59:00Z","timezone":"Pacific\/Honolulu","timezone_db":"UTC","date_type":"date"}]},"field_pearson_ann_id":{"und":[{"value":"29947550","format":null,"safe_value":"29947550"}]},"field_pearson_ann_startdisplayda":{"und":[{"value":"2011-01-19T07:00:00Z","timezone":"Pacific\/Honolulu","timezone_db":"UTC","date_type":"date"}]},"field_pearson_ann_subject":{"und":[{"value":"Extra credit opportunity ","format":null,"safe_value":"Extra credit opportunity "}]},"field_pearson_ann_submitter":{"und":[{"value":"Kory Manahan","format":null,"safe_value":"Kory Manahan"}]},"field_pearson_ann_text":{"und":[{"value":"There is a guest speaker coming in from Microsoft, if you attend youll be able to get 5 points extra credit for a two-paragraph summary of his speech.","format":null,"safe_value":"There is a guest speaker coming in from Microsoft, if you attend youll be able to get 5 points extra credit for a two-paragraph summary of his speech."}]},"field_pearson_ann_course":{"und":[{"target_id":"227"}]},"rdf_mapping":{"rdftype":["sioc:Item","foaf:Document"],"title":{"predicates":["dc:title"]},"created":{"predicates":["dc:date","dc:created"],"datatype":"xsd:dateTime","callback":"date_iso8601"},"changed":{"predicates":["dc:modified"],"datatype":"xsd:dateTime","callback":"date_iso8601"},"body":{"predicates":["content:encoded"]},"uid":{"predicates":["sioc:has_creator"],"type":"rel"},"name":{"predicates":["foaf:name"]},"comment_count":{"predicates":["sioc:num_replies"],"datatype":"xsd:integer"},"last_activity":{"predicates":["sioc:last_activity_date"],"datatype":"xsd:dateTime","callback":"date_iso8601"}},"ajax_example":{"example_1":0,"example_2":""},"cid":0,"last_comment_timestamp":"1383942962","last_comment_name":"","last_comment_uid":"1","comment_count":0,"name":"mpurvis","picture":"1","data":"b:0;"},"is_new":false,"created":1383943382,"timestamp":1383943382,"uuid":"2b8165f3-a6e4-4d15-ad6f-c5bffcb2d99a","vuuid":"1dda29fb-c1ec-4477-956a-9749dd3fc21f"}');
	// dsm($node, 'node');
	$nodeObj = node_load($node->field_pearson_ann_course->und[0]->target_id);
	// dsm($nodeObj, 'loaded course');

	$subject = $node->field_pearson_ann_subject->und[0]->value;
	$text = $node->field_pearson_ann_text->und[0]->value;
	$text = (strlen($text) > 53) ? substr($text,0,50).'...' : $text;
		
	$courseCode = $nodeObj->field_pearson_course_code[LANGUAGE_NONE][0]['value'];
	
	// dsm($subject);
	// dsm($text);
	// dsm($courseCode);
	
	// determine if new or updated announcement
	$msg = '';
	if ($update){
		$msg = 'Updated announcement for ' . $courseCode . ': ' . $subject . ' - ' . $text;
	} else {
		$msg = 'New announcement for ' . $courseCode . ': ' . $subject . ' - ' . $text;
	}	

	// get student information, send text to all people who have entered their cell number
	$numbers = array();
	foreach ($nodeObj->field_pearson_course_users[LANGUAGE_NONE] as $key => $value) {
		$uid = $value['target_id'];
		$userObj = user_load($uid);
		if (!empty($userObj->field_pearson_user_phone)){
			// this user has entered a phone number, send a text message
			$number = $userObj->field_pearson_user_phone[LANGUAGE_NONE][0]['value'];
			if (function_exists('twilio_send')) twilio_send($number, $msg);
		} 
	}
}

function _rule_iqt($node, $update = FALSE){
	// $node is IQT
	// $nodeObj is Course
	
	// $json = json_encode($node);
	// dsm($json, 'json');
	// return;
	// $node = json_decode('{"title":"Quiz 8","type":"pearson_iqt","uid":1,"status":1,"comment":0,"promote":0,"moderate":0,"sticky":0,"language":"und","field_pearson_iqt_titleheading":{"und":[{"value":"Week 8"}]},"field_pearson_iqt_time":{"und":[{"value":"2014-01-19T07:00:00Z","timezone":"UTC","timezone_db":"UTC","date_type":"date"}]},"field_pearson_iqt_guid":{"und":[{"value":"0899bb77-f484-4af6-9db3-6507c8e50eba"}]},"field_pearson_iqt_pointspossible":{"und":[{"value":20}]},"field_pearson_iqt_course":{"und":[{"target_id":"227","target_type":"node"}]},"changed":1384454238,"nid":"291","vid":"291","original":{"vid":"291","uid":"1","title":"Quiz 8","log":"","status":"1","comment":"0","promote":"0","sticky":"0","vuuid":"325a3c23-3529-4222-a64c-f2404b40ca8b","nid":"291","type":"pearson_iqt","language":"und","created":"1384453712","changed":"1384453712","tnid":"0","translate":"0","uuid":"2f25bccd-0d22-4702-a626-f7fc27e59134","revision_timestamp":"1384453712","revision_uid":"1","field_pearson_iqt_course":{"und":[{"target_id":"227"}]},"field_pearson_iqt_titleheading":{"und":[{"value":"Week 8","format":null,"safe_value":"Week 8"}]},"field_pearson_iqt_time":{"und":[{"value":"2014-01-19T07:00:00Z","timezone":"UTC","timezone_db":"UTC","date_type":"date"}]},"field_pearson_iqt_guid":{"und":[{"value":"0899bb77-f484-4af6-9db3-6507c8e50eba","format":null,"safe_value":"0899bb77-f484-4af6-9db3-6507c8e50eba"}]},"field_pearson_iqt_pointspossible":{"und":[{"value":"20"}]},"rdf_mapping":{"rdftype":["sioc:Item","foaf:Document"],"title":{"predicates":["dc:title"]},"created":{"predicates":["dc:date","dc:created"],"datatype":"xsd:dateTime","callback":"date_iso8601"},"changed":{"predicates":["dc:modified"],"datatype":"xsd:dateTime","callback":"date_iso8601"},"body":{"predicates":["content:encoded"]},"uid":{"predicates":["sioc:has_creator"],"type":"rel"},"name":{"predicates":["foaf:name"]},"comment_count":{"predicates":["sioc:num_replies"],"datatype":"xsd:integer"},"last_activity":{"predicates":["sioc:last_activity_date"],"datatype":"xsd:dateTime","callback":"date_iso8601"}},"cid":0,"last_comment_timestamp":"1384453712","last_comment_name":"","last_comment_uid":"1","comment_count":0,"name":"mpurvis","picture":"1","data":"b:0;"},"is_new":false,"created":1384454238,"timestamp":1384454238,"uuid":"1f38156c-bf88-47d2-ac27-14cea015946b","vuuid":"a8bb37b2-f54e-4a82-9449-f5d7e437cfc4"}');
	dsm($node, 'node');
	
	// $nodeObj = node_load($node->field_pearson_iqt_course->und[0]->target_id);
	$nodeObj = node_load($node->field_pearson_iqt_course[LANGUAGE_NONE][0]['target_id']);
	// dsm($nodeObj, 'loaded course');
	// return;

	// $subject = $node->field_pearson_ann_subject->und[0]->value;
	// $text = $node->field_pearson_ann_text->und[0]->value;
	// $text = (strlen($text) > 53) ? substr($text,0,50).'...' : $text;
	
	$titleHeading = $node->field_pearson_iqt_titleheading[LANGUAGE_NONE][0]['value'];
	// $titleHeading = $node->field_pearson_iqt_titleheading->und[0]->value;
	// $t = new DateTime($node->field_pearson_iqt_time->und[0]->value);
	$t = new DateTime($node->field_pearson_iqt_time[LANGUAGE_NONE][0]['value']);
	$time = $t->format('l, n/j/Y'); // Monday, 1/19,2014
	$points = $node->field_pearson_iqt_pointspossible[LANGUAGE_NONE][0]['value'];
	// $points = $node->field_pearson_iqt_pointspossible->und[0]->value;
		
	$courseCode = $nodeObj->field_pearson_course_code[LANGUAGE_NONE][0]['value'];
	
	// dsm($subject);
	// dsm($text);
	// dsm($courseCode);
	
	// determine if new or updated announcement
	$msg = '';
	if ($update){
		$msg = 'UPDATE: Upcoming Exam for ' . $courseCode . ' on ' . $time . ' during ' . $titleHeading;
	} else {
		$msg = 'Upcoming Exam for ' . $courseCode . ' on ' . $time . ' during ' . $titleHeading;
	}	

	// get student information, send text to all people who have entered their cell number
	$numbers = array();
	foreach ($nodeObj->field_pearson_course_users[LANGUAGE_NONE] as $key => $value) {
		$uid = $value['target_id'];
		$userObj = user_load($uid);
		if (!empty($userObj->field_pearson_user_phone)){
			// this user has entered a phone number			
			$number = $userObj->field_pearson_user_phone[LANGUAGE_NONE][0]['value'];
			// now check to see if they have set a goal for this class
			$q = db_select('field_data_field_pearson_goal_user', 'u');
			$q->join('field_data_field_pearson_goal_course', 'c', 'u.entity_id = c.entity_id');
			$q->fields('u', array('entity_id'))->condition('u.field_pearson_goal_user_target_id', $uid)->condition('c.field_pearson_goal_course_target_id', $nodeObj->nid);
			$r = $q->execute()->fetch(); // only one goal per course
			if (empty($r)){
				// they have no goal
				$msg .= '. This will be worth ' . $points . ' points.';
			} else {
				// they have a goal, append the message
				$goalObj = node_load($r->entity_id);
				$percent = $goalObj->field_pearson_goal_percent[LANGUAGE_NONE][0]['value'];
				// now we need to get the total points for the class, add the points for this item
				//		and calculate what they'll need to get on this exam
				// BELOW: recorded as one of the API calls in todo.txt
				$rosterTotalsObj = remoteOAuth1('/courses/' . $nodeObj->field_pearson_course_number[LANGUAGE_NONE][0]['value'] . '/gradebook/rostercoursegradestodate');
				// dsm($rosterTotalsObj, '$rosterTotalsObj');
				// this contains all the students, so loop through until we find the correct user
				foreach ($rosterTotalsObj->rosterCourseGradesToDate as $k2) {
					$pearsonUID = $userObj->field_pearson_user_id[LANGUAGE_NONE][0]['value'];
					if ($k2->student->id == $pearsonUID){
						// then lets get the earned and possible points for this person
						$earnedPoints = $k2->courseGradeToDate->earned;
						$possiblePoints = $k2->courseGradeToDate->possible;
						// TODO: LEFTOFF here where i need to calculate how much this person needs to get on the exam to reach their goal, and append it to the $msg
						// calculate what they need to maintain their goal
						dsm($percent, 'percent (goal)');
						dsm($earnedPoints, 'earnedPoints');
						dsm($possiblePoints, 'possiblePoints');
						dsm($points, 'points for upcoming item');
						
						
						$need = (($percent * ($possiblePoints + $points)) / 100) - $earnedPoints;		
						dsm($need, 'need');				
						// dont want the value to be above the total available
						if ($need > $points){
							// they can't possible reach their goal, even with a perfect score
							$msg .= '. Try your best on this item to meet your ' . $percent . '% goal!';
						} else if ($need < 0){
							// they already have a much higher percentage than their set goal
							$msg .= '. You will meet your ' . $percent . '% goal with or without a great score.';
						} else {
							// there is a value they can score that will bring them to their goal
							$msg .= '. You can reach your ' . $percent . '% goal by scoring a ' . $need . '/' . $points . '.';
						}
					}
				}

			}
			
			dsm($msg, 'message to text');
			if (function_exists('twilio_send')) twilio_send($number, $msg);
		}
	}
}

/*
 * $type is 'ann' or 'course'
 * $node is node deleted by Rules
 */
function _remove_hash($type, $node){
	if ($type == 'ann')
		$pid = $node->field_pearson_ann_id[LANGUAGE_NONE][0]['value'];
	else if ($type == 'course')
		$pid = $node->field_pearson_course_id[LANGUAGE_NONE][0]['value'];
	else if ($type == 'iqt')
		$pid = $node->field_pearson_iqt_guid[LANGUAGE_NONE][0]['value'];  
		
	db_delete('pearson_mp_hashes')
	  ->condition('type', $type)
	  ->condition('description', $pid)
	  ->execute();
}
